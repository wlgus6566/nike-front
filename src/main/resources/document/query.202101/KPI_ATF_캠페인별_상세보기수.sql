# -- 캠페인별 상세보기 수
# SELECT TC.TOP_MENU_CODE, TC.MENU_CODE, SUM(TC.READ_COUNT) AS SUM
# FROM TB_CONTENTS TC
# GROUP BY TC.TOP_MENU_CODE, TC.MENU_CODE
;
#
# SELECT *
# FROM TB_USER_ACTION_LOG TUAL
# WHERE TUAL.METHOD_SIGNATURE = 'findContents'
# AND TUAL.METHOD_TYPE_NAME = 'GET'
# AND TUAL.URL LIKE '%ASSET%'
;


-- ASSET 게시물별 상세보기 수
-- TOOLKIT 게시물별 상세보기 수
-- FOUNDATION 게시물별 상세보기 수
SELECT tc.FOLDER_NAME
     , SUM(CASE
               WHEN T.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
                   THEN 1
               ELSE 0
    END) 'ELE'
FROM TB_CONTENTS tc
         LEFT JOIN (
    SELECT SUBSTRING_INDEX(TUAL.URL, '/', -1) AS CONTENTS_SEQ, TUAL.REGISTRATION_DT
    FROM TB_USER_ACTION_LOG TUAL
    WHERE TUAL.METHOD_SIGNATURE = 'findContents'
      AND REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
#     AND TUAL.DEVICE = 'PC'
#     AND TUAL.DEVICE = 'MO'
) T
                   ON T.CONTENTS_SEQ = tc.CONTENTS_SEQ
WHERE tc.TOP_MENU_CODE = 'ASSET'
# WHERE tc.TOP_MENU_CODE = 'TOOLKIT'
# WHERE tc.TOP_MENU_CODE = 'FOUNDATION'
GROUP BY tc.CONTENTS_SEQ
;


-- ASSET 게시물별 상세보기 수
-- 특정 기간 TOOLKIT 게시물별 상세보기 수
-- 특정 기간 FOUNDATION 게시물별 상세보기 수
SELECT tc.FOLDER_NAME
     , SUM(CASE
#                WHEN T.REGISTRATION_DT BETWEEN '2020-10-24 00:00:00' AND '2020-11-15 23:59:59' THEN 1
#                WHEN T.REGISTRATION_DT BETWEEN '2020-11-16 00:00:00' AND '2020-12-15 23:59:59' THEN 1
               WHEN T.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59' THEN 1
               ELSE 0
    END) 'MON'
FROM TB_CONTENTS tc
         LEFT JOIN (
    SELECT SUBSTRING_INDEX(TUAL.URL, '/', -1) AS CONTENTS_SEQ, TUAL.REGISTRATION_DT
    FROM TB_USER_ACTION_LOG TUAL
    WHERE TUAL.METHOD_SIGNATURE = 'findContents'
#       AND TUAL.REGISTRATION_DT BETWEEN '2020-10-24 00:00:00' AND '2020-11-15 23:59:59'
      AND TUAL.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
) T
ON T.CONTENTS_SEQ = tc.CONTENTS_SEQ
WHERE tc.TOP_MENU_CODE = 'ASSET'
# WHERE tc.TOP_MENU_CODE = 'TOOLKIT'
# WHERE tc.TOP_MENU_CODE = 'FOUNDATION'
# AND tc.REGISTRATION_DT BETWEEN '2020-10-24 00:00:00' AND '2020-11-15 23:59:59'
AND tc.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
GROUP BY tc.CONTENTS_SEQ
;



SELECT tc.FOLDER_NAME
     , SUM(CASE
               WHEN T.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59' THEN 1
               ELSE 0
    END) 'MON'
FROM TB_CONTENTS tc
         LEFT JOIN (
    SELECT tcf.CONTENTS_SEQ, tdl.REGISTRATION_DT
    FROM TB_DOWNLOAD_LOG tdl
             INNER JOIN TB_CONTENTS_FILE tcf
                        ON tdl.FILE_SEQ = tcf.CONTENTS_FILE_SEQ
    WHERE tdl.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
      AND tdl.DOWNLOAD_TYPE = 'CONTENTS'
) T
                   ON T.CONTENTS_SEQ = tc.CONTENTS_SEQ
WHERE tc.TOP_MENU_CODE = 'ASSET'
# WHERE tc.TOP_MENU_CODE = 'TOOLKIT'
# WHERE tc.TOP_MENU_CODE = 'FOUNDATION'
  AND tc.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
# WHERE tc.TOP_MENU_CODE = 'FOUNDATION'
GROUP BY tc.CONTENTS_SEQ
;



SELECT *
FROM TB_USER_ACTION_LOG
WHERE METHOD_SIGNATURE = 'findContents'
;



-- A/T/F별 상세보기 수
SELECT
CATEGORY, COUNT(CATEGORY) AS COUNT
FROM (
    SELECT CASE
    WHEN URL LIKE '%ASSET%' AND URL LIKE '%SP%' THEN 'ASSET_SP'
    WHEN URL LIKE '%ASSET%' AND URL LIKE '%SU%' THEN 'ASSET_SU'
    WHEN URL LIKE '%ASSET%' AND URL LIKE '%FA%' THEN 'ASSET_FA'
    WHEN URL LIKE '%ASSET%' AND URL LIKE '%HO%' THEN 'ASSET_HO'

    WHEN URL LIKE '%FOUNDATION%' AND URL LIKE '%VMS%' THEN 'FOUNDATION_VMS'
    WHEN URL LIKE '%FOUNDATION%' AND URL LIKE '%EKIN%' THEN 'FOUNDATION_EKIN'
    WHEN URL LIKE '%FOUNDATION%' AND URL LIKE '%DIGITAL%' THEN 'FOUNDATION_DIGITAL'
    WHEN URL LIKE '%FOUNDATION%' AND URL LIKE '%RB%' THEN 'FOUNDATION_RB'

    WHEN URL LIKE '%TOOLKIT%' AND URL LIKE '%VMS%' THEN 'TOOLKIT_VMS'
    WHEN URL LIKE '%TOOLKIT%' AND URL LIKE '%EKIN%' THEN 'TOOLKIT_EKIN'
    WHEN URL LIKE '%TOOLKIT%' AND URL LIKE '%SOCIAL%' THEN 'TOOLKIT_SOCIAL'
    WHEN URL LIKE '%TOOLKIT%' AND URL LIKE '%RB%' THEN 'TOOLKIT_RB'
    END AS CATEGORY
    FROM TB_USER_ACTION_LOG
    WHERE METHOD_SIGNATURE = 'findContents'
    AND METHOD_TYPE_NAME = 'GET'
#     AND REGISTRATION_DT BETWEEN '2020-12-16 00:00:00' AND '2021-01-15 23:59:59'
    AND REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
#     AND DEVICE = 'PC'
#     AND DEVICE = 'MO'

) A
GROUP BY CATEGORY;




# 테스트 쿼리
# 액션로ㄱ, > 콘텐츠 상세조회는 2020-10-26 17:04:53 부터 시작
SELECT *
FROM TB_USER_ACTION_LOG TUAL
WHERE TUAL.METHOD_SIGNATURE = 'findContents'
order by ACTION_LOG_SEQ asc
#   AND REGISTRATION_DT BETWEEN '2020-11-01 11:35:00' AND '2020-11-30 23:59:59'

SELECT count(*)
FROM TB_USER_ACTION_LOG TUAL
WHERE TUAL.METHOD_SIGNATURE = 'findContents'
  AND TUAL.METHOD_TYPE_NAME = 'GET'
  AND TUAL.URL LIKE '%ASSET%'
#                     AND TUAL.URL LIKE '%TOOLKIT%'
#                     AND TUAL.URL LIKE '%FOUNDATION%'
#           AND TUAL.REGISTRATION_DT BETWEEN '2020-12-16 00:00:00' AND '2021-01-15 23:59:59'
  AND TUAL.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
#   AND TUAL.REGISTRATION_DT BETWEEN '2021-01-16 00:00:00' AND '2021-02-15 23:59:59'
;
1749
;


SELECT
     SUM(CASE
               WHEN T.REGISTRATION_DT BETWEEN '2020-11-13 11:35:00' AND '2020-11-30 23:59:59' THEN 0
               WHEN T.REGISTRATION_DT BETWEEN '2020-12-01 00:00:00' AND '2020-12-31 23:59:59' THEN 1
               ELSE 0
    END) 'TWO'
FROM TB_CONTENTS tc
         LEFT JOIN (
    SELECT SUBSTRING_INDEX(TUAL.URL, '/', -1) AS CONTENTS_SEQ, TUAL.REGISTRATION_DT
    FROM TB_USER_ACTION_LOG TUAL
    WHERE TUAL.METHOD_SIGNATURE = 'findContents'
      AND REGISTRATION_DT BETWEEN '2020-12-01' AND '2020-12-31 23:59:59'
) T
                   ON T.CONTENTS_SEQ = tc.CONTENTS_SEQ
# WHERE tc.TOP_MENU_CODE = 'ASSET'
GROUP BY tc.CONTENTS_SEQ
;